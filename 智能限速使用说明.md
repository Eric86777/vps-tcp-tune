# 🔥 智能限速功能使用说明

## 📝 功能说明

智能限速功能会根据你输入的**目标有效带宽**，自动计算实际需要设置的 `tc fq maxrate` 值，补偿网络重传和协议开销。

---

## 🎯 核心概念

### **普通限速 vs 智能限速**

| 模式 | 你输入 | 实际设置 | TCP 实测 | 有效带宽 |
|------|--------|---------|---------|---------|
| **普通限速** | 300 mbit | 300 mbit | 252 Mbps | 210 Mbps（❌ 不符合预期）|
| **智能限速** | 300 Mbps | 420 mbit | 353 Mbps | 300 Mbps（✅ 符合预期）|

### **为什么需要补偿？**

```
你的输入（目标有效带宽）：300 Mbps
                ↓
         需要补偿三部分损耗
                ↓
    ┌─────────────────────────────┐
    │ 1. 重传损耗（5-20%）        │
    │ 2. TCP/IP 协议开销（5%）    │
    │ 3. 安全余量（10-15%）       │
    └─────────────────────────────┘
                ↓
       自动计算实际 maxrate
                ↓
      实际设置：420 mbit（+40%）
                ↓
      最终有效带宽：≈ 300 Mbps ✅
```

---

## 📊 补偿系数说明

| 链路类型 | 典型丢包率 | 补偿系数 | 示例 |
|---------|-----------|---------|------|
| **高丢包链路** | 10-20% | 1.40x | 联通 9929、CN2 GT |
| **中等链路** | 5-10% | 1.30x | CN2 GIA、部分直连 |
| **优质链路** | < 5% | 1.20x | BGP、IPLC、IEPL |
| **自动检测** | 动态 | 动态 | ping 检测丢包率 |

---

## 🚀 使用步骤

### **1. 运行脚本**
```bash
sudo bash net-tcp-tune.sh
```

### **2. 选择智能限速**
```
选择：6（🔥 智能限速）
```

### **3. 输入目标有效带宽**
```
=== 智能限速配置 ===

说明：
  - 目标带宽：实际可用的 TCP 传输速度（扣除重传、协议开销）
  - 实际设置：会自动放大 30-40%，补偿重传和开销

常见场景推荐：
  • 联通 9929（300M 瓶颈）：目标 250 Mbps
  • 电信 CN2（500M 瓶颈）：目标 450 Mbps
  • 移动 CMI（1000M）：目标 900 Mbps

请输入目标有效带宽（数字，单位 Mbps）: 300
```

### **4. 选择链路类型**
```
请选择链路类型（影响补偿系数）：
1. 高丢包链路（联通 9929、部分 CN2 GT）- 补偿 40%
2. 中等链路（CN2 GIA、部分直连）- 补偿 30%
3. 优质链路（BGP、IPLC、IEPL）- 补偿 20%
4. 自动检测（推荐）

选择（1-4）[默认 4]: 1
```

### **5. 确认配置**
```
=== 计算结果 ===
链路类型: 高丢包链路
补偿系数: 1.40x
目标有效带宽: 300 Mbps
实际设置 maxrate: 420 Mbit

预期效果：
  • TCP 理论带宽: 约 420 Mbps
  • 扣除重传和开销后
  • 实际有效带宽: 约 300 Mbps ✅

确认应用此配置？(Y/N): Y
```

### **6. 验证效果**
```bash
# 运行网络测试
iperf3 -c 目标服务器 -t 30

# 检查配置
tc qdisc show | grep maxrate
# 应该看到：maxrate 420Mbit
```

---

## 📈 实际案例

### **案例 1：9929 联通中转（你的情况）**

**需求：**
- 上行瓶颈：9929 约 300M
- 实际丢包：16-17%
- 目标：实际可用带宽 250 Mbps

**配置：**
```
输入目标：250 Mbps
链路类型：高丢包（1.40x）
实际设置：350 mbit
```

**预期结果：**
```
TCP 测试带宽：约 350 Mbps
重传次数：约 16000 次（16% 重传率）
有效带宽：约 250 Mbps ✅
```

---

### **案例 2：CN2 GIA 优化**

**需求：**
- 带宽：500M CN2 GIA
- 实际丢包：5%
- 目标：实际可用带宽 450 Mbps

**配置：**
```
输入目标：450 Mbps
链路类型：中等（1.30x）
实际设置：585 mbit
```

**预期结果：**
```
TCP 测试带宽：约 585 Mbps
重传次数：约 6000 次（5% 重传率）
有效带宽：约 450 Mbps ✅
```

---

### **案例 3：IPLC 专线**

**需求：**
- 带宽：1000M IPLC
- 实际丢包：< 1%
- 目标：实际可用带宽 900 Mbps

**配置：**
```
输入目标：900 Mbps
链路类型：优质（1.20x）
实际设置：1080 mbit
```

**预期结果：**
```
TCP 测试带宽：约 1080 Mbps
重传次数：< 500 次（< 1% 重传率）
有效带宽：约 900 Mbps ✅
```

---

## 🔍 自动检测功能

选择"自动检测"时，脚本会：

1. 要求输入测试目标 IP
2. 发送 20 个 ping 包
3. 根据丢包率自动选择系数：
   - 丢包 ≥ 10%：使用 1.40x（高丢包）
   - 丢包 5-10%：使用 1.30x（中等）
   - 丢包 < 5%：使用 1.20x（优质）

**示例：**
```bash
正在自动检测链路质量...
请输入测试目标 IP（回车跳过自动检测）: 167.253.156.50

--- ping statistics ---
20 packets transmitted, 18 received, 10% packet loss

=== 计算结果 ===
链路类型: 高丢包链路（检测到 10% 丢包）
补偿系数: 1.40x
...
```

---

## ⚠️ 注意事项

### **1. 输入的是目标值，不是瓶颈值**

```
❌ 错误：我的线路瓶颈是 300M，输入 300
✅ 正确：我希望实际可用带宽 250M，输入 250（留 50M 余量）
```

### **2. 首次使用建议保守**

```
瓶颈 300M → 首次输入 200-220
瓶颈 500M → 首次输入 400-430
瓶颈 1000M → 首次输入 850-900
```

### **3. 需要迭代调整**

```
第一次：输入 250 → 测试 → 实际 230 Mbps
第二次：输入 270 → 测试 → 实际 250 Mbps ✅
```

---

## 🛠️ 手动调整

如果智能限速效果不理想：

```bash
# 1. 查看当前配置
tc qdisc show | grep maxrate

# 2. 手动微调（±10%）
sudo tc qdisc replace dev ens3 root fq maxrate 380mbit

# 3. 重新测试
iperf3 -c 目标服务器 -t 30

# 4. 继续调整直到满意
```

---

## 📝 总结

### **智能限速的优势**
✅ **省心**：不需要自己计算补偿系数  
✅ **精准**：考虑了重传、协议开销、安全余量  
✅ **灵活**：支持手动选择或自动检测链路类型  
✅ **实用**：输入即目标，输出即效果  

### **适用场景**
- ✅ 有明确带宽瓶颈的中转/代理
- ✅ 需要精确控制单连接带宽
- ✅ 多用户共享场景，防止抢占
- ✅ 链路质量不稳定（丢包）的环境

### **不适用场景**
- ❌ 无限速需求（直接用选项 8 取消限速）
- ❌ 链路质量极差（> 30% 丢包），建议更换线路
- ❌ 需要动态调整的场景（智能限速是静态配置）

---

**祝优化顺利！** 🚀
